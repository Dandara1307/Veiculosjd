<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Detector de Falhas Mecânicas - Transportadora</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap');
  html, body {
    margin: 0; padding: 0;
    font-family: 'Montserrat', sans-serif;
    background: linear-gradient(135deg, #330000, #660000);
    color: #f5f5f5;
    height: 100%;
  }
  body {
    display: flex;
    flex-direction: column;
    align-items: center;
    min-height: 100vh;
    overflow-y: auto;
    padding-bottom: 2rem;
  }
  header {
    width: 100%;
    background-color: #1a0000cc;
    box-shadow: 0 0 15px #aa0000;
    padding: 1rem 0.5rem;
    text-align: center;
    position: sticky;
    top: 0;
    z-index: 10;
  }
  header h1 {
    margin: 0;
    font-weight: 700;
    font-size: 1.8rem;
    letter-spacing: 1px;
    color: #ff3333;
    text-shadow: 0 0 8px #ff0000bb;
  }
  main {
    max-width: 480px;
    width: 100%;
    padding: 1rem;
    box-sizing: border-box;
  }
  select, input[type="text"] {
    width: 100%;
    max-width: 320px;
    padding: 0.6rem 0.8rem;
    margin: 0.5rem 0 1rem 0;
    font-size: 1rem;
    border-radius: 8px;
    border: 2px solid #ff0000;
    background-color: #330000;
    color: #ff6666;
    font-weight: 700;
    transition: background-color 0.3s ease, color 0.3s ease;
  }
  select:hover, select:focus, input[type="text"]:hover, input[type="text"]:focus {
    background-color: #ff0000;
    color: #220000;
    outline: none;
    cursor: pointer;
    box-shadow: 0 0 8px #ff3300;
  }
  video {
    width: 100%;
    border-radius: 12px;
    box-shadow: 0 0 25px #ff0000cc;
    background: #220000;
    border: 3px solid #ff0000;
    display: block;
  }
  #status {
    margin-top: 1rem;
    background: #660000;
    padding: 1rem;
    border-radius: 14px;
    font-weight: 700;
    font-size: 1.3rem;
    text-align: center;
    min-height: 3.5rem;
    box-shadow: 0 0 25px #ff3300;
    color: #ff4444;
    display: none;
    user-select: none;
  }
  #instructions {
    margin-top: 1rem;
    font-size: 0.95rem;
    background: #440000cc;
    padding: 1rem 1.2rem;
    border-radius: 12px;
    line-height: 1.4;
    color: #ff9999;
    user-select: none;
    box-shadow: 0 0 10px #990000cc;
  }
  .section {
    background: #220000cc;
    padding: 1rem 1.2rem;
    margin-top: 1.5rem;
    border-radius: 12px;
    box-shadow: 0 0 14px #aa0000cc;
  }
  .section h2 {
    margin-top: 0;
    color: #ff4444;
    text-shadow: 0 0 6px #ff0000cc;
  }
  ul.checklist {
    list-style-type: none;
    padding-left: 0;
  }
  ul.checklist li {
    margin-bottom: 0.6rem;
  }
  ul.checklist label {
    cursor: pointer;
    font-weight: 600;
    font-size: 1.05rem;
    color: #ff8888;
  }
  ul.checklist input[type="checkbox"] {
    margin-right: 0.8rem;
    transform: scale(1.3);
    cursor: pointer;
  }
  button {
    margin-top: 1rem;
    background-color: #ff0000;
    border: none;
    color: #330000;
    font-weight: 700;
    font-size: 1.1rem;
    padding: 0.6rem 1.2rem;
    border-radius: 10px;
    box-shadow: 0 0 12px #ff3333;
    cursor: pointer;
    transition: background-color 0.3s ease, color 0.3s ease;
  }
  button:hover, button:focus {
    background-color: #cc0000;
    color: #ffdddd;
    outline: none;
  }
  #report-output {
    white-space: pre-wrap;
    background-color: #330000;
    color: #ffbbbb;
    border-radius: 10px;
    padding: 1rem;
    margin-top: 1rem;
    max-height: 200px;
    overflow-y: auto;
    font-family: monospace, monospace;
  }
  #weekly-check {
    font-size: 0.95rem;
    color: #ff6666;
    font-weight: bold;
    margin-bottom: 0.5rem;
    user-select: none;
  }
  small.note {
    display: block;
    font-size: 0.75rem;
    color: #aa4444;
    margin-top: 0.3rem;
  }
</style>
</head>
<body>
<header>
  <h1>Detector de Falhas Mecânicas</h1>
</header>
<main>
  <label for="vehicle-select">Selecionar modelo do veículo:</label>
  <select id="vehicle-select" aria-label="Selecionar modelo do veículo">
    <option value="carreta">Carreta</option>
    <option value="truck">Truck</option>
    <option value="toco">Toco</option>
    <option value="delivery">Delivery</option>
    <option value="fiorino">Fiorino</option>
    <option value="3/4">3/4</option>
    <option value="van">Van</option>
  </select>
  
  <label for="plate-input">Placa do veículo:</label>
  <input type="text" id="plate-input" maxlength="8" placeholder="Ex: ABC1D23" aria-label="Placa do veículo" pattern="[A-Za-z]{3}[0-9][A-Za-z0-9][0-9]{2}" />

  <div id="weekly-check" aria-live="polite"></div>

  <div class="section" id="checklist-section" aria-label="Checklist diário/ semanal do veículo">
    <h2>Checklist Diário / Semanal</h2>
    <form id="checklist-form">
      <ul class="checklist">
        <li><label><input type="checkbox" name="iluminacao" /> Luzes e sinalização funcionando</label></li>
        <li><label><input type="checkbox" name="freios" /> Teste dos freios</label></li>
        <li><label><input type="checkbox" name="oleo" /> Verificação do nível de óleo</label></li>
        <li><label><input type="checkbox" name="pneus" /> Condição e calibragem dos pneus</label></li>
        <li><label><input type="checkbox" name="partes_criticas" /> Verificar partes mecânicas críticas</label></li>
        <li><label><input type="checkbox" name="fluido_freio" /> Nível e estado do fluido de freio</label></li>
        <li><label><input type="checkbox" name="bateria" /> Estado da bateria</label></li>
      </ul>
      <button type="submit" aria-label="Salvar checklist">Salvar Checklist</button>
    </form>
    <small class="note">* Checklist obrigatório semanalmente</small>
  </div>

  <video id="video" autoplay playsinline></video>
  <div id="status" role="alert" aria-live="assertive"></div>
  <div id="instructions" aria-live="polite">
    <strong>Instruções:</strong> Aponte a câmera do seu celular para o veículo. Este app simula a detecção de falhas mecânicas reconhecendo tons vermelhos fortes na imagem como "Falha detectada". Selecione o modelo do veículo e informe a placa. Preencha o checklist semanalmente. Se uma falha for detectada, o problema será exibido na tela e um alerta sonoro será acionado.
  </div>

  <div class="section" id="report-section" aria-label="Relatório gerado">
    <h2>Relatório da inspeção</h2>
    <button id="generate-report-btn" aria-label="Gerar relatório">Gerar Relatório</button>
    <button id="clear-data-btn" aria-label="Limpar dados armazenados">Limpar Dados</button>
    <pre id="report-output" tabindex="0" aria-live="polite" aria-atomic="true"></pre>
  </div>
</main>

<audio id="alert-sound" src="https://actions.google.com/sounds/v1/alarms/alarm_clock.ogg" preload="auto"></audio>

<script>
  const video = document.getElementById('video');
  const statusDiv = document.getElementById('status');
  const alertSound = document.getElementById('alert-sound');
  const vehicleSelect = document.getElementById('vehicle-select');
  const plateInput = document.getElementById('plate-input');
  const checklistForm = document.getElementById('checklist-form');
  const reportOutput = document.getElementById('report-output');
  const generateReportBtn = document.getElementById('generate-report-btn');
  const clearDataBtn = document.getElementById('clear-data-btn');
  const weeklyCheckDiv = document.getElementById('weekly-check');

  let falhaDetectada = false;
  let lastCheckDate = null;

  // Helper for date format dd/mm/yyyy
  function formatDate(d) {
    const day = d.getDate().toString().padStart(2, '0');
    const month = (d.getMonth() +1).toString().padStart(2, '0');
    const year = d.getFullYear();
    return `${day}/${month}/${year}`;
  }

  // Save checklist and last check date in localStorage
  function saveChecklist(date, checkedItems) {
    localStorage.setItem('checklistDate', date.toISOString());
    localStorage.setItem('checklistData', JSON.stringify(checkedItems));
  }

  function loadChecklist() {
    try {
      const dateStr = localStorage.getItem('checklistDate');
      if(dateStr) {
        lastCheckDate = new Date(dateStr);
        const savedData = localStorage.getItem('checklistData');
        if(savedData) {
          const parsed = JSON.parse(savedData);
          for(const [name, val] of Object.entries(parsed)) {
            const checkbox = checklistForm.elements[name];
            if(checkbox) {
              checkbox.checked = val;
            }
          }
        }
      }
      const savedPlate = localStorage.getItem('vehiclePlate');
      if(savedPlate) {
        plateInput.value = savedPlate;
      }
      const savedVehicle = localStorage.getItem('vehicleModel');
      if(savedVehicle) {
        vehicleSelect.value = savedVehicle;
      }
    } catch(e) {
      console.warn('Falha ao carregar os dados armazenados:', e);
    }
  }

  function mandatoryWeeklyCheckMessage() {
    if (!lastCheckDate) {
      return 'Você ainda não realizou o checklist semanal.';
    }
    const now = new Date();
    const diffTime = Math.abs(now - lastCheckDate);
    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
    if(diffDays > 7) {
      return `⚠️ Aviso: Já se passaram ${diffDays} dias desde seu último checklist semanal. Por favor, realize o checklist para manter seu veículo seguro.`;
    } else {
      return `✔️ Último checklist realizado em: ${formatDate(lastCheckDate)}. Próximo obrigatório em até ${7 - diffDays} dias.`;
    }
  }

  checklistForm.addEventListener('submit', e => {
    e.preventDefault();
    const checkedItems = {};
    for(const el of checklistForm.elements) {
      if(el.type === 'checkbox') {
        checkedItems[el.name] = el.checked;
      }
    }
    const now = new Date();
    saveChecklist(now, checkedItems);
    lastCheckDate = now;
    updateWeeklyCheckStatus();
    alert('Checklist salvo com sucesso!');
  });

  function updateWeeklyCheckStatus() {
    weeklyCheckDiv.textContent = mandatoryWeeklyCheckMessage();
  }

  generateReportBtn.addEventListener('click', () => {
    const veiculo = vehicleSelect.value || 'Não informado';
    const placa = plateInput.value.trim() || 'Não informada';
    localStorage.setItem('vehiclePlate', placa);
    localStorage.setItem('vehicleModel', veiculo);
    let checklistStatus = 'Checklist não realizado.';
    const savedData = localStorage.getItem('checklistData');
    if(savedData) {
      const data = JSON.parse(savedData);
      checklistStatus = Object.entries(data).map(([key,val])=>{
        return `${formatChecklistItem(key)}: ${val ? 'OK' : 'NÃO OK'}`;
      }).join('\n');
    }
    const dataRelatorio = `RELATÓRIO DE INSPEÇÃO
Data: ${formatDate(new Date())}
Veículo: ${veiculo}
Placa: ${placa}

Status do checklist:
${checklistStatus}

Status da câmera:
${falhaDetectada ? '⚠️ Falha mecânica detectada durante inspeção.' : '✔️ Nenhuma falha detectada.'}

Recomendações:
- Realize inspeções regulares.
- Em caso de falha, verifique o veículo imediatamente.
- Mantenha a documentação do veículo atualizada.
`;

    reportOutput.textContent = dataRelatorio;
    reportOutput.focus();
  });

  clearDataBtn.addEventListener('click', () => {
    if(confirm('Tem certeza que deseja limpar todos os dados armazenados (checklist, placa, veículo, relatórios)?')) {
      localStorage.removeItem('checklistDate');
      localStorage.removeItem('checklistData');
      localStorage.removeItem('vehiclePlate');
      localStorage.removeItem('vehicleModel');
      reportOutput.textContent = '';
      lastCheckDate = null;
      updateWeeklyCheckStatus();
      resetChecklistForm();
      plateInput.value = '';
      vehicleSelect.value = 'carreta';
      alert('Dados limpos com sucesso.');
    }
  });

  function resetChecklistForm() {
    for(const el of checklistForm.elements) {
      if(el.type === 'checkbox') {
        el.checked = false;
      }
    }
  }

  function formatChecklistItem(key) {
    const map = {
      iluminacao: 'Luzes e sinalização',
      freios: 'Freios',
      oleo: 'Nível de óleo',
      pneus: 'Pneus',
      partes_criticas: 'Partes mecânicas críticas',
      fluido_freio: 'Fluído dos freios',
      bateria: 'Bateria'
    };
    return map[key] || key;
  }

  async function configurarCamera() {
    try {
      const stream = await navigator.mediaDevices.getUserMedia({video: {facingMode: 'environment'}, audio: false});
      video.srcObject = stream;
      return new Promise(resolve => {
        video.onloadedmetadata = () => {
          resolve();
        };
      });
    } catch (err) {
      alert('Não foi possível acessar a câmera. Por favor, permita o uso da câmera e tente novamente.');
      console.error(err);
    }
  }

  function detectarFalha(ctx, largura, altura) {
    const imagem = ctx.getImageData(0, 0, largura, altura);
    const dados = imagem.data;
    let pixelsVermelhos = 0;
    const totalPixels = largura * altura;

    for(let i = 0; i < dados.length; i += 4) {
      const r = dados[i];
      const g = dados[i + 1];
      const b = dados[i + 2];

      // Detectar vermelho forte (r dominante e claro)
      if (r > 150 && g < 100 && b < 100) {
        pixelsVermelhos++;
      }
    }
    return (pixelsVermelhos / totalPixels) > 0.03; // se >3% pixels vermelhos, falha detectada
  }

  async function iniciarDeteccao() {
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');

    // Wait video size
    function waitVideoSize() {
      return new Promise(resolve => {
        if(video.videoWidth && video.videoHeight) {
          resolve();
        } else {
          // fallback 200ms polling
          setTimeout(() => {
            resolve();
          }, 200);
        }
      });
    }
    await waitVideoSize();

    canvas.width = video.videoWidth || 320;
    canvas.height = video.videoHeight || 240;

    function loopDeteccao() {
      if (video.readyState === video.HAVE_ENOUGH_DATA) {
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
        const falha = detectarFalha(ctx, canvas.width, canvas.height);

        if (falha) {
          if (!falhaDetectada) {
            falhaDetectada = true;
            const veiculo = vehicleSelect.value;
            statusDiv.textContent = `⚠️ Falha mecânica detectada no seu veículo modelo: ${veiculo}! Verifique imediatamente!`;
            statusDiv.style.display = 'block';
            alertSound.play();
          }
        } else {
          if (falhaDetectada) {
            falhaDetectada = false;
            statusDiv.style.display = 'none';
          }
        }
      }
      requestAnimationFrame(loopDeteccao);
    }
    loopDeteccao();
  }

  // Initialization
  (async () => {
    loadChecklist();
    updateWeeklyCheckStatus();
    await configurarCamera();
    iniciarDeteccao();
  })();
</script>
</body>
</html>

